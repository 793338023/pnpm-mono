# monorepo

它是什么，多包单仓库的代码管理模式，是传统的多包多仓库相悖

解决:

- 多仓库管理困难，开启多个编译器，因为在仓库很多的情况下开发者需要对每个项目要求管理者赋权并且每次开发都要查找项目，若每个仓库都有自己的一套操作流程，会更大的更加开发者的心智负担
- 项目之间依赖更容易
- 项目之间共享依赖包，使空间使用变小
- 应用级的渐进式升级更容易，比如把应用包拆分粒度更小，到后续旧项目重构时会更加友好
- 对于新人更加友好，因为所需的项目都在一起了，无需拉取下载依赖包等繁琐操作，在团队协作上会更简单，因为代码都是可见的，并且可复用

缺点:

- 仓库变大的速度会更快
- 仓库代码都是可见的，无法做代码权限管理
- 部署变得困难，因为单仓库只需考虑当前项目的打包部署，但多包需要考虑每个包的打包部署情况
- 对于管理仓库人员要求变高，因为需要一套更加严格的提交合入规范

## 什么时候考虑使用

大系统需要拆分的或者长期维护的项目，因为拆分后还是需要整合在一起的，使用它更加容易，而且在项目上易于重构

而项目之间互相依赖并且依赖项会频繁变化，这是可以考虑，因为包之间的关联它更加简单，不需要发布部署升级依赖的一系列操作，只需要使用 lerna 之类的工具命令操作

若对包的代码权限重要或者涉及第三方团队协同开发，那就不要考虑

因为在缺点上，权限管理是一个无解问题，其他的问题都可以使用规范或者技术的手段解决

# pnpm

pnpm 的 nomorepo 很简单

创建一个 pnpm-workspace.yaml，规定好它的工作空间，在根目录执行命令，就可以做到依赖包的共享，项目之间的依赖等

安装依赖

```
pnpm i
```

给所有的包安装同一第三方包

```
pnpm install react react-dom -w
```

-r 遍历所有的包，--filter 指定的包进行指令操作

对应应用安装共享的包

```
pnpm i common -r --filter app-web
```

执行 app-web 项目的 script，启动项目

```
pnpm start -r --filter app-web
```

如果在使用脚手架初始化项目报错时提示缺少包，有可能是脚手架项目没有在项目依赖此包，即非法访问依赖包导致的，pnpm 不允许此行为
解决方式-在项目里加上此依赖

出现依赖包内的包的依赖版本不对导致的错误，可以在根上加上此包版本

pnpmfile.js 更改依赖项修正版本

包的变动可以使用 `git diff --name-only`获取上次提交与这次提交的区别列表或 tag 的差异

lerna 有更加完善 monorepo 工具，是个很成熟的方案

https://segmentfault.com/a/1190000023954051

pnpm

https://pnpm.io/zh/how-peers-are-resolved

pnpm 新项目可尝试，因为依赖严格，会导致一些应用在依赖上不严格的情况下报错，而且对 jest 有点不兼容，issue 一堆 jest 的问题

https://github.com/pnpm/pnpm/issues?page=1&q=is%3Aissue+jest
